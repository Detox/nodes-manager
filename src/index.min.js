/*
 0BSD
*/
(function(){function k(l,k){function g(a,b,c){var d=this;null==b&&(b=1E3);null==c&&(c=q);if(!(this instanceof g))return new g(a,b,c);k.call(this);this.j=b;this.i=c;this.g=n();b=0;for(c=a.length;b<c;++b){var e=a[b];var f=p(e.split(":")[0]);this.g.set(f,e)}this.h=n();this.f=h();this.b=h();this.c=n();this.a=n();this.o=r(this.i,function(){var b=+new Date-2E3*d.i;d.a.forEach(function(a,c){if(a<b)d.a["delete"](c)})})}var p=l.hex2array;var m=l.pull_random_item_from_array;var t=l.are_arrays_equal;var r=l.intervalSet;
var n=l.ArrayMap;var h=l.ArraySet;g.prototype={add_bootstrap_node:function(a,b){if(this.h.has(a))this.fire("peer_warning",a);else{var c=p(b.split(":")[0]);this.g.set(c,b);this.h.set(a,c)}},get_bootstrap_nodes:function(){return Array.from(this.g.values())},get_candidates_for_disconnection:function(a){var b=this;var c=h(a);var d=[];this.b.forEach(function(a){c.has(a)||b.f.has(a)||b.c.has(a)||d.push(a)});return d},add_connected_node:function(a){this.b.add(a);this.a["delete"](a);this.fire("connected_nodes_count",
this.b.size);this.fire("aware_of_nodes_count",this.a.size)},get_random_connected_nodes:function(a){return this.l(a)},l:function(a,b){var c=[];null==a&&(a=1);null==b&&(b=[]);if(!this.b.size)return null;var d=Array.from(this.b.values());var e=h(b.concat(Array.from(this.h.keys())));d=d.filter(function(a){return!e.has(a)});if(!d.length)return null;for(b=0;b<a&&d.length;++b)c.push(m(d));return c},has_connected_node:function(a){return this.b.has(a)},del_connected_node:function(a){this.b["delete"](a);this.c["delete"](a);
this.fire("connected_nodes_count",this.b.size)},set_peer:function(a,b){this.c.set(a,h(b))},set_aware_of_nodes:function(a,b){var c;var d=this.c.get(a);var e=0;for(c=b.length;e<c;++e){var f=b[e];if(d&&d.has(f)){this.fire("peer_warning",a);return}}a=this.m();e=0;for(c=b.length;e<c;++e)if(f=b[e],!this.b.has(f))if(this.a.has(f)||this.a.size<this.j)this.a.set(f,+new Date);else if(a.length)d=m(a),this.a["delete"](d),this.a.set(f,+new Date);else break;this.fire("aware_of_nodes_count",this.a.size)},get_aware_of_nodes:function(a){var b,
c,d=this;var e=[];var f=Array.from(this.a.keys());for(b=0;7>b&&f.length;++b)(c=m(f))&&e.push(c);var g=h();this.c.forEach(function(b,c){t(a,c)||b.forEach(function(a){d.c.has(a)||g.add(a)})});g=Array.from(g);b=0;for(f=Math.min(5,10-e.length);b<f&&g.length;++b)(c=m(g))&&e.push(c);return e},more_aware_of_nodes_needed:function(){return!!(this.a.size<this.j||this.m(!0).length)},m:function(a){null==a&&(a=!1);var b=[];var c=+new Date-1E3*this.i;var d=!1;this.a.forEach(function(e,f){!d&&e<c&&(b.push(f),a&&
!d&&(d=!0))});return b},get_nodes_for_routing_path:function(a,b){var c;null==b&&(b=[]);b=Array.from(this.f.values()).concat(b);var d=null!=(c=this.l(1,b))?c[0]:void 0;if(!d)return null;a=this.u(a-1,b.concat([d]));if(!a)return null;this.f.add(d);return[d].concat(a)},u:function(a,b){var c=[];if(this.a.size<a)return null;var d=Array.from(this.a.keys());if(b){var e=h(b);d=d.filter(function(a){return!e.has(a)})}if(d.length<a)return null;for(b=0;b<a;++b)c.push(m(d));return c},del_first_node_in_routing_path:function(a){this.f["delete"](a)},
destroy:function(){this.s||(this.s=!0,clearInterval(this.o))}};g.prototype=Object.assign(Object.create(k.prototype),g.prototype);Object.defineProperty(g.prototype,"constructor",{value:g});return g}var q=300;"function"===typeof define&&define.amd?define(["@detox/utils","async-eventer"],k):"object"===typeof exports?module.exports=k(require("@detox/utils"),require("async-eventer")):this.detox_nodes_manager=k(this.detox_utils,this.async_eventer)}).call(this);