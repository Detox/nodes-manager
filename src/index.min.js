/*
 0BSD
*/
(function(){function l(m,l){function h(a,b,c){var d=this;null==b&&(b=1E3);null==c&&(c=r);if(!(this instanceof h))return new h(a,b,c);l.call(this);this.l=b;this.j=c;this.g=p();b=0;for(c=a.length;b<c;++b){var e=a[b];var f=q(e.split(":")[0]);this.g.set(f,e)}this.h=p();this.f=k();this.b=k();this.c=p();this.a=p();this.o=t(this.j,function(){var b=+new Date-2E3*d.j;d.a.forEach(function(a,c){if(a<b)d.a["delete"](c)})})}var q=m.hex2array;var n=m.pull_random_item_from_array;var u=m.are_arrays_equal;var t=m.intervalSet;
var p=m.ArrayMap;var k=m.ArraySet;h.prototype={add_bootstrap_node:function(a,b){if(this.h.has(a))this.fire("peer_warning",a);else{var c=q(b.split(":")[0]);this.g.set(c,b);this.h.set(a,c)}},get_bootstrap_nodes:function(){return Array.from(this.g.values())},get_candidates_for_disconnection:function(a){var b=this;var c=k(a);var d=[];this.b.forEach(function(a){c.has(a)||b.f.has(a)||b.c.has(a)||d.push(a)});return d},add_connected_node:function(a){this.b.add(a);this.a["delete"](a);this.fire("connected_nodes_count",
this.b.size);this.fire("aware_of_nodes_count",this.a.size)},get_random_connected_nodes:function(a){return this.m(a)},m:function(a,b){var c=[];null==a&&(a=1);null==b&&(b=[]);if(!this.b.size)return null;var d=Array.from(this.b.values());var e=k(b.concat(Array.from(this.h.keys())));d=d.filter(function(a){return!e.has(a)});if(!d.length)return null;for(b=0;b<a&&d.length;++b)c.push(n(d));return c},has_connected_node:function(a){return this.b.has(a)},del_connected_node:function(a){this.b["delete"](a);this.c["delete"](a);
this.fire("connected_nodes_count",this.b.size)},set_peer:function(a,b){this.c.set(a,k(b))},set_aware_of_nodes:function(a,b){var c,d;if(10<b.length)this.fire("peer_error",a);else{var e=this.c.get(a);var f=c=0;for(d=b.length;f<d;++f){var g=b[f];e&&e.has(g)&&++c}if(5<c)this.fire("peer_error",a);else{a=this.i();f=0;for(d=b.length;f<d;++f)if(g=b[f],!this.b.has(g))if(this.a.has(g)||this.a.size<this.l)this.a.set(g,+new Date);else if(a.length)e=n(a),this.a["delete"](e),this.a.set(g,+new Date);else break;
this.fire("aware_of_nodes_count",this.a.size)}}},get_aware_of_nodes:function(a){var b,c;var d=[a].concat(this.i());d=k(d);if(this.c.has(a)){var e=0;for(c=(b=Array.from(this.c.get(a))).length;e<c;++e){var f=b[e];d.add(f)}}b=[];c=Array.from(this.a.keys());for(e=0;7>e&&c.length;++e)(f=n(c))&&!d.has(f)&&b.push(f);var g=k();this.c.forEach(function(b,c){u(a,c)||b.forEach(function(a){d.has(a)||g.add(a)})});g=Array.from(g);e=0;for(f=Math.min(5,10-b.length);e<f&&g.length;++e)(c=n(g))&&b.push(c);return b},
more_aware_of_nodes_needed:function(){return!!(this.a.size<this.l||this.i(!0).length)},i:function(a){null==a&&(a=!1);var b=[];var c=+new Date-1E3*this.j;var d=!1;this.a.forEach(function(e,f){!d&&e<c&&(b.push(f),a&&!d&&(d=!0))});return b},get_nodes_for_routing_path:function(a,b){var c;null==b&&(b=[]);b=Array.from(this.f.values()).concat(b);var d=null!=(c=this.m(1,b))?c[0]:void 0;if(!d)return null;a=this.u(a-1,b.concat([d]));if(!a)return null;this.f.add(d);return[d].concat(a)},u:function(a,b){var c=
[];if(this.a.size<a)return null;var d=Array.from(this.a.keys());if(b){var e=k(b);d=d.filter(function(a){return!e.has(a)})}if(d.length<a)return null;for(b=0;b<a;++b)c.push(n(d));return c},del_first_node_in_routing_path:function(a){this.f["delete"](a)},destroy:function(){this.s||(this.s=!0,clearInterval(this.o))}};h.prototype=Object.assign(Object.create(l.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{value:h});return h}var r=300;"function"===typeof define&&define.amd?define(["@detox/utils",
"async-eventer"],l):"object"===typeof exports?module.exports=l(require("@detox/utils"),require("async-eventer")):this.detox_nodes_manager=l(this.detox_utils,this.async_eventer)}).call(this);